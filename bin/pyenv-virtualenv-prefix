#!/usr/bin/env bash
#
# Summary: Display real_prefix for a Python virtualenv version.
#
# Usage: pyenv virtualenv-prefix [<virtualenv>]

set -e
[ -n "$PYENV_DEBUG" ] && set -x

if [ -z "$PYENV_ROOT" ]; then
  PYENV_ROOT="${HOME}/.pyenv"
fi

if [ -n "$1" ]; then
  virtualenvs=($@)
  IFS=: PYENV_VERSION="${versions[*]}"
  export PYENV_VERSION
else
  IFS=: virtualenvs=($(pyenv-virtualenv-name))
fi

real_prefix() { # virtualenv
  local virtualenv="$1"
  PYENV_VERSION="${virtualenv}" pyenv-exec python -c 'import sys;print(sys.real_prefix)' 2>/dev/null
}

base_prefix() { # pyvenv
  # FIXME: non-pyvenv versions also have sys.base_prefix
  local virtualenv="$1"
  PYENV_VERSION="${virtualenv}" pyenv-exec python -c 'import sys;print(sys.base_prefix)' 2>/dev/null
}

VIRTUALENV_PREFIX_PATHS=()
for virtualenv in "${virtualenvs[@]}"; do
  if [ "$virtualenv" = "system" ]; then
    echo "pyenv-virtualenv: version \`${virtualenv}' is not a virtualenv" 1>&2
    exit 1
  fi
  PREFIX="$(pyenv-prefix "${virtualenv}")"
  if [ -f "${PREFIX}/bin/activate" ]; then
    # Anaconda has `activate` script nevertheless it is not a virtual environment (#65)
    if [ -f "${PREFIX}/bin/conda" ]; then
      echo "pyenv-virtualenv: version \`${virtualenv}' is an anaconda/miniconda" 1>&2
      exit 1
    else
      VIRTUALENV_PREFIX_PATH="$(real_prefix "${virtualenv}" || base_prefix "${virtualenv}" || true)"
      VIRTUALENV_PREFIX_PATHS=("${VIRTUALENV_PREFIX_PATHS[@]}" "$VIRTUALENV_PREFIX_PATH")
    fi
  else
    echo "pyenv-virtualenv: version \`${virtualenv}' is not a virtualenv" 1>&2
    exit 1
  fi
done

IFS=: echo "${VIRTUALENV_PREFIX_PATHS[*]}"
